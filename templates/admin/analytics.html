{% extends "admin/base.html" %}

{% block title %}Analytics - Admin Panel{% endblock %}

{% block admin_content %}
<!-- Header -->
<header class="dashboard-header">
    <div>
        <h1><i class="fas fa-chart-bar"></i> Analytics Dashboard</h1>
        <p style="color: var(--accent-brown); margin: 5px 0 0 0;">Comprehensive insights and performance metrics</p>
    </div>
    <div class="header-actions">
        <button class="action-btn" onclick="refreshAnalytics()">
            <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
    </div>
</header>

<!-- Analytics Cards -->
<section class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
        <div class="stat-value">{{ analytics.total_orders }}</div>
        <div class="stat-label">Total Orders</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
        <div class="stat-value">${{ "%.2f"|format(analytics.total_revenue) }}</div>
        <div class="stat-label">Total Revenue</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
        <div class="stat-value">{{ "%.1f"|format(analytics.growth_rate) }}%</div>
        <div class="stat-label">Growth Rate</div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon"><i class="fas fa-star"></i></div>
        <div class="stat-value">{{ "%.1f"|format(analytics.avg_rating) }}</div>
        <div class="stat-label">Avg Rating</div>
    </div>
</section>

<!-- Content Grid -->
<div class="content-grid">
    <!-- Main Content -->
    <div class="main-section">
        <!-- Charts Section -->
        <section class="quick-actions">
            <h3><i class="fas fa-chart-area"></i> Performance Charts</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Monthly Revenue</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="revenueChart" width="400" height="200"
                                data-labels='{{ analytics.monthly_labels|tojson|safe }}'
                                data-revenue='{{ analytics.monthly_revenue|tojson|safe }}'
                                data-users='{{ analytics.monthly_users|tojson|safe }}'></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>User Growth</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="userGrowthChart" width="400" height="200"
                                data-labels='{{ analytics.monthly_labels|tojson|safe }}'
                                data-users='{{ analytics.monthly_users|tojson|safe }}'></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Top Products -->
        <section class="recent-activity">
            <h3><i class="fas fa-trophy"></i> Top Performing Products</h3>
            <div class="card">
                <div class="card-body">
                    {% if analytics.top_products %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Sales</th>
                                    <th>Revenue</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in analytics.top_products[:5] %}
                                <tr>
                                    <td>
                                        <strong>{{ product.name }}</strong><br>
                                        <small class="text-muted">{{ product.category }}</small>
                                    </td>
                                    <td>{{ product.sales_count }}</td>
                                    <td>${{ "%.2f"|format(product.revenue) }}</td>
                                    <td>
                                        <span class="badge bg-warning">
                                            <i class="fas fa-star"></i> {{ "%.1f"|format(product.rating if product.rating else 0.0) }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted"></i>
                        <h5 class="mt-3 text-muted">No analytics data available</h5>
                        <p class="text-muted">Analytics data will appear as users interact with the platform.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>
    </div>

    <!-- Sidebar Widgets -->
    <div class="sidebar-widgets">
        <!-- Key Metrics -->
        <section class="system-status">
            <h4><i class="fas fa-tachometer-alt"></i> Key Metrics</h4>
            <div class="status-item">
                <span class="status-label">Conversion Rate</span>
                <span class="status-value">{{ "%.1f"|format(analytics.conversion_rate) }}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Avg Order Value</span>
                <span class="status-value">${{ "%.2f"|format(analytics.avg_order_value) }}</span>
            </div>
            <div class="status-item">
                <span class="status-label">Customer Retention</span>
                <span class="status-value">{{ "%.1f"|format(analytics.retention_rate) }}%</span>
            </div>
            <div class="status-item">
                <span class="status-label">Active Sellers</span>
                <span class="status-value">{{ analytics.active_sellers }}</span>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="system-status" style="margin-top: 30px;">
            <h4><i class="fas fa-clock"></i> Recent Activity</h4>
            {% if analytics.recent_activity %}
            {% for activity in analytics.recent_activity[:5] %}
            <div class="status-item">
                <span class="status-label">{{ activity.type }}</span>
                <span class="status-value">{{ activity.count }}</span>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">No recent activity</p>
            {% endif %}
        </section>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Safely parse backend data into JS
    const chartLabels = JSON.parse('{{ analytics.monthly_labels|tojson|safe }}');
    const chartRevenue = JSON.parse('{{ analytics.monthly_revenue|tojson|safe }}');
    const chartUsers = JSON.parse('{{ analytics.monthly_users|tojson|safe }}');

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: chartLabels.length > 0 ? chartLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Revenue ($)',
                data: chartRevenue.length > 0 ? chartRevenue : [1200, 1900, 3000, 5000, 2000, 3000],
                borderColor: '#8B4513',
                backgroundColor: 'rgba(139, 69, 19, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // User Growth Chart
    const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
    new Chart(userGrowthCtx, {
        type: 'bar',
        data: {
            labels: chartLabels.length > 0 ? chartLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'New Users',
                data: chartUsers.length > 0 ? chartUsers : [50, 80, 120, 200, 150, 180],
                backgroundColor: '#5D4037',
                borderColor: '#4E342E',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
});

function refreshAnalytics() {
    location.reload();
}
</script>
{% endblock %}
